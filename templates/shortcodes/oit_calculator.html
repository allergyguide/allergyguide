{% set tools = load_data(path="/js/tools_versioning.json") %}
{% set tool_info = tools.oit_calculator %}
<div class="oit_calculator">
	<div class="oit-toolbar">
		<div class="oit-version-auth">
			<a href="{{ get_url(path='@/tools/resources/oit_calculator_changelog.md') }}" target="_blank" rel="noopener noreferrer" class="changelog-link"><span>v{{ tool_info.version }}</span></a>
			<button id="btn-login-trigger" class="login-link-btn" title="Login" aria-label="Login">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
					<path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
					<path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
				</svg>
			</button>
			<span id="user-badge" class="user-badge" style="display: none;"></span>
			<button id="btn-logout-trigger" class="login-link-btn" style="display: none;" title="Logout" aria-label="Logout">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
					<path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
					<path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
				</svg>
			</button>
			<script>
				(function() {
					try {
						var s = JSON.parse(localStorage.getItem('oit_session_active'));
						// If valid session exists
						if (s && s.valid && s.expiresAt > Date.now()) {
							// hide login
							var btnLogin = document.getElementById('btn-login-trigger');
							if (btnLogin) btnLogin.style.display = 'none';
							// show logout
							var btnLogout = document.getElementById('btn-logout-trigger');
							if (btnLogout) btnLogout.style.display = 'inline-block';
							// show badge
							var b = document.getElementById('user-badge');
							if (b){
								b.textContent = s.username || '...';
								b.style.display = 'inline';
								b.classList.add('oit-data-syncing');
							}
						}
						} catch(e) {
							// if err / invalid json, do nothing; default just to login
						}
						})();
			</script>
		</div>
	</div>
	<!-- Workspace Header (Tabs + Actions) -->
	<div class="oit-workspace-header">
		<div id="oit-tabs-list" class="oit-tabs-list">
			<!-- Pre-rendered default state to prevent layout shift (replaced by JS on load) -->
			<div class="oit-tab active">
				<span class="status-dot"></span>
				<span class="tab-title">Untitled 1</span>
				<span class="oit-tab-close" title="Close Tab">×</span>
			</div>
			<div class="oit-tab-add" title="Add New Tab">+</div>
		</div>
		<div class="oit-header-actions">
			<button id="btn-undo" class="btn-secondary" disabled title="Undo (Ctrl+z)">
				↶ Undo
			</button>
			<button id="btn-redo" class="btn-secondary" disabled title="Redo (Ctrl+y)">
				↷ Redo
			</button>
		</div>
	</div>

	<!-- Food Selection and Settings -->
	<div class="settings-container">
		<!-- Food A Container -->
		<div class="food-a-container">
			<div class="search-container">
				<input type="text"
				       id="food-a-search"
				       placeholder="Search for foods, protocols, or make custom food..."
				       class="search-input"
				       autocomplete="off"
				>
			</div>
			<!-- Food A settings will be dynamically inserted here -->
		</div>
		<!-- Food B Container -->
		<div class="food-b-container disabled">
			<h3>Optional Transition Food</h3>
			<div class="search-container">
				<input type="text"
				       id="food-b-search"
				       placeholder="Search for food or create one to transition to..."
				       class="search-input"
				       autocomplete="off"
				       disabled
				>
				<button id="clear-food-b" class="clear-food-b" disabled>
					Clear
				</button>
			</div>
			<!-- Food B settings will be dynamically inserted here -->
		</div>
	</div>
	<!-- Dosing Strategy Selection -->
	<div class="dosing-strategy-container oit-hidden-on-init">
		<!-- Dosing strategy buttons will be dynamically inserted here -->
	</div>
	<div class="step-controls-footer oit-hidden-on-init">
		<span class="subtle-text">Use
			<span class="mini-btn-add">+</span>
			<span class="mini-btn-remove">−</span>
			buttons to add/remove steps</span>
	</div>
	<!-- Protocol Output -->
	<div class="output-container">
		<template id="empty-state-template">
			{% include "shortcodes/oit_calculator_components/table_instructions.html" %}
		</template>
		<table>
			{% include "shortcodes/oit_calculator_components/table_instructions.html" %}
		</table>
		<div class="bottom-section oit-hidden-on-init">
			<div class="export-container">

				<div class="export-buttons">
					<button class="btn-export" id="export-ascii">Copy to Clipboard</button>
					<button class="btn-export" id="export-pdf">Export PDF</button>
				</div>

				<div id="save-request-wrapper" style="display: none; margin-top: 1rem;">
					<button id="btn-trigger-save-request" class="btn-save-protocol-action" style="width: 100%;">
						Request Save Protocol
					</button>
				</div>

				<div class="custom-note-container">
					<label for="custom-note">Notes:</label>
					<textarea id="custom-note"
					          class="custom-note-textarea"
					          placeholder="Add any custom notes or instructions ..."
					          rows="8"
					></textarea>
				</div>
			</div>

			<div class="warnings-container">
				<div class="no-warnings">Protocol passes internal checks.</div>
			</div>
		</div>
	</div>
</div>
{% include "shortcodes/oit_calculator_components/login_modal.html" %}
{% include "shortcodes/oit_calculator_components/clickwrap_modal.html" %}
{% include "shortcodes/oit_calculator_components/save_protocol_request_modal.html" %}
{% include "shortcodes/oit_calculator_components/debug_panel.html" %}
<!-- Hidden div to get URL for warnings to pass into JS using zola -->
<div id="url-container"
     data-target-url="{{ get_url(path='@/tools/resources/oit_calculator_validation.md') }}"
     style="display: none;"
></div>
<!-- Load main script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit"
        defer
></script>
<script type="module" src="/js/{{ tool_info.file }}"></script>
